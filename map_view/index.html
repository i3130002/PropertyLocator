<!DOCTYPE html>
<html>

<head>
  <title>Empty HTML Page</title>
  <style>
    #map {
      width: 100%;
      height: 100%;
      position: absolute;
    }

    #map {
      float: left;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    var editorExtensionId = "cnapcgckldopdofeilibaomjkokjealg";
    var geos = []
    function on_location_data(response) {
      geos = response.geos
      console.log("on_locaiton_data", geos)

      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: { lat: 25.2048, lng: 55.2708 }
      });
      setMarkers(map, geos)
    }


    function initMap() {
      console.log("initMap")
      chrome.runtime.sendMessage(editorExtensionId, "Get me the goes",
        function (response) {
          console.log("initMap before setTimeout")
          setTimeout(on_location_data(response), 2000)
        });
      console.log("chrome.runtime.sendMessage sent")
    }

    function setMarkers(map, geos) {
      var image = {
        url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
        size: new google.maps.Size(20, 32),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(0, 32)
      };
      var shape = {
        coords: [1, 1, 1, 20, 18, 20, 18, 1],
        type: 'poly'
      };
      for (var i = 0; i < geos.length; i++) {
        var geo = geos[i];
        console.log(geo)
        let marker_data = {
          position: { lat: geo.latitude, lng: geo.longitude },
          map: map,
          icon: image,
          shape: shape,
          title: geo.price + " " + geo.name + " " + geo.description,
          zIndex: 1,
          ref_index: i
        }
        console.log(marker_data)
        var marker = new google.maps.Marker(marker_data);
        (function (marker) {
          google.maps.event.addListener(marker, 'click', function () {
            console.log(marker.ref_index);
            window.open(geos[marker.ref_index].url, "_blank");
          });
        })(marker);

      }
    } 
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWAoxTVd_zUi11jJe9TEvu6MUoOfzTerE&callback=initMap&loading=async"></script>
</body>

</html>